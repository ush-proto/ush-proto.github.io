<html>

<head>
  <title>USH - Analyse des marchés</title>
  <meta charset="utf-8">
  <link rel="icon" type="image/x-icon" href="./favicon.png">
  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>

<body style="padding-top: 100px;">
<nav class="navbar navbar-expand-lg fixed-top" style="background-color: #e3f2fd;">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Démonstrateur USH - Analyse des marchés impliquant les organismes du logement social</a>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        
      </ul>
        <button class="btn btn-outline-success"type="button" data-bs-toggle="offcanvas" data-bs-target="#menu" aria-controls="menu">Sélection</button>
    </div>
  </div>
</nav>

<div class="offcanvas offcanvas-end" tabindex="-1" id="menu" aria-labelledby="offcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvasExampleLabel">Sélection</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div class="row">
      <div class="col-sm-12">
        <div class="input-group mb-3">
          <div class="form-floating">
            <select id="selection-famille" class="form-select" placeholder="Selection">
              <option value="" disabled selected>Selectionnez une famille d'OLS...</option>
            </select>
            <label for="selection-type-perimetre">Famille d'OLS</label>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-sm-12">
        <div class="input-group mb-3">
          <div class="form-floating">
            <select id="selection-type-perimetre" class="form-select" placeholder="Selection">
              <option value="" disabled selected>Selectionnez un type de périmètre...</option>
            </select>
            <label for="selection-type-perimetre">Type de périmètre</label>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <div class="input-group mb-3">
            <div class="form-floating">
              <select id="selection-perimetre" class="form-select" placeholder="Selection">
                <option value="" disabled selected>Selectionnez un périmètre...</option>
              </select>
              <label for="selection-perimetre">Périmètre</label>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-12">
          <div class="input-group mb-3">
            <div class="form-floating">
              <select id="selection-typologie" class="form-select" placeholder="Selection">
                <option value="" disabled selected>Selectionnez une typologie...</option>
              </select>
              <label for="selection-typologie">Type de biens</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>




<div class="container-fluid">

  <ul class="nav nav-tabs" id="tabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="analyse1-tab" data-bs-toggle="tab" data-bs-target="#analyse1" type="button"
        role="tab" aria-controls="analyse1" aria-selected="true">Type périmètre</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="analyse2-tab" data-bs-toggle="tab" data-bs-target="#analyse2" type="button"
        role="tab" aria-controls="analyse2" aria-selected="false">Périmètre</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="analyse3-tab" data-bs-toggle="tab" data-bs-target="#analyse3" type="button"
        role="tab" aria-controls="analyse3" aria-selected="false">Type de bien</button>
    </li>
  </ul>

  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="analyse1" role="tabpanel" aria-labelledby="analyse1-tab" tabindex="0">
      <h4 class="mt-3" id="title-type-perimetre"></h4><hr/>
      <div class="row mt-2">
        <div class="col-sm-6">
          <div class="card" style="min-height: 700px">
            <div class="card-body" id="graphe1">
            </div>
          </div>
        </div>
        <div class="col-sm-6">
          <div class="card" style="min-height: 700px">
            <div class="card-body" id="graphe2">
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-sm-6">
          <div class="card" style="min-height: 700px">
            <div class="card-body" id="graphe3">
            </div>
          </div>
        </div>
        <div class="col-sm-6">
          <div class="card" style="min-height: 700px">
            <div class="card-body" id="graphe4">
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade active" id="analyse2" role="tabpanel" aria-labelledby="analyse2-tab" tabindex="0">
      <h4 class="mt-3" id="title-perimetre"></h4><hr/>
      <div class="row mt-2">
        <div class="col-sm-12">
          <div class="card" style="min-height: 700px">
            <div class="card-body" id="graphe5">
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-sm-12">
          <div class="card" style="min-height: 700px">
            <div class="card-body" id="graphe6">
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade active" id="analyse3" role="tabpanel" aria-labelledby="analyse3-tab" tabindex="0">
      <h4 class="mt-3" id="title-typo"></h4><hr/>
      <div class="row mt-2">
        <div class="col-sm-12">
          <div class="card" style="min-height: 700px">
            <div class="card-body" id="graphe7">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
  <script type='text/javascript'>
        function plot(graph, chart) {
            var figure = JSON.parse(graph)
            Plotly.newPlot(chart, figure, {});
        }
   </script>
  
  <py-config type="toml">
    packages = ["pandas", "plotly"]

    [[fetch]]
    files = ['indicateurs_OLS.sqlite3']
  </py-config>

  <py-script>

    import js
    from js import document
    from pyodide import create_proxy
    from pyscript import Element
    
    from plotly.io import to_html
    import plotly.graph_objects as go
    from plotly.subplots import make_subplots
    import plotly.express as px
    import pandas as pd
    import sqlite3

    WIDTH_GRAPHE = document.getElementById("graphe1").offsetWidth - 50

    bdd_result = "indicateurs_OLS.sqlite3"

    conn_sqlite = sqlite3.connect(bdd_result)

    ########################################################################
    # FONCTIONS MISE EN PLACE DES PARAMETRES
    ########################################################################

    TYPES =  {
        "Regions": "region",
        "Principales métropoles": "epci",
        "Zonage ABC": "zonage_ABC",
        "Zonage 123 ": "zonage_123",
    }

    famille = "Tout OLS"
    type_perimetre = "region"
    perimetre = None 
    typo = "Foncier Nu"

    CATEGORIES = [
        {"code": "P1", "valeur": "ETAT"},
        {"code": "P2", "valeur": "REGION"},
        {"code": "P3", "valeur": "DEPARTEMENT"},
        {"code": "P4", "valeur": "INTERCOMMUNALITE"},
        {"code": "P5", "valeur": "COMMUNE"},
        {"code": "P6", "valeur": "COLLECTIVITE TERRITORIALE AUTRE"},
        {"code": "P0", "valeur": "AUTRE PERSONNE MORALE PUBLIQUE"},
        {"code": "F1", "valeur": "ORGANISME LOGEMENT SOCIAL"},
        {"code": "F2", "valeur": "ETABLISSEMENT PUBLIC FONCIER"},
        {"code": "A4", "valeur": "SAFER"},
        {"code": "F4", "valeur": "SEM / SPLA"},
        {"code": "F5", "valeur": "AMENAGEUR FONCIER"},
        {"code": "F6", "valeur": "PROMOTEUR IMMOBILIER PRIVE"},
        {"code": "F7", "valeur": "INVESTISSEUR PROFESSIONNEL"},
        {"code": "A1", "valeur": "STRUCTURE AGRICOLE"},
        {"code": "A2", "valeur": "STRUCTURE FORESTIERE"},
        {"code": "A3", "valeur": "STRUCTURE DU FONCIER ENVIRONNEMENTALE"},
        {"code": "R1", "valeur": "CONCESSIONNAIRE AUTOROUTIER"},
        {"code": "R2", "valeur": "RESEAU FERRE"},
        {"code": "R3", "valeur": "STRUCTURE AERIENNE"},
        {"code": "R4", "valeur": "STRUCTURE FLUVIALE OU MARITIME"},
        {"code": "R5", "valeur": "RESEAU ELECTRIQUE OU GAZ"},
        {"code": "R0", "valeur": "PROPRIETAIRE DE RESEAU AUTRE"},
        {"code": "M0", "valeur": "AUTRE PERSONNE MORALE"},
        {"code": "X0", "valeur": "PERSONNE PHYSIQUE"},
        {"code": "X1", "valeur": "PERSONNE PHYSIQUE"},
        {"code": "R6", "valeur": "RESEAU EAU OU ASSAINISSEMENT"},
        {"code": "R7", "valeur": "RESEAU DE TELECOMMUNICATION"},
        {"code": "G1", "valeur": "SOCIETE CIVILE IMMOBILIERE"},
        {"code": "G2", "valeur": "PROPRIETE DIVISEE EN LOT"},
        {"code": None, "valeur": "INCONNU"},
    ]

    def etiquette(typo):
        for etiquette, code in TYPES.items():
            if code == typo:
                return etiquette
        return typo

    def nom(categorie):
        for elt in CATEGORIES:
            if elt["code"] == categorie:
                return elt["valeur"]
        return categorie


    def get_type_perimetre():
        selector = document.getElementById("selection-type-perimetre") 
        for nom, code in TYPES.items():
            opt = document.createElement("option")
            opt.innerHTML = nom
            opt.value = code
            if code == type_perimetre:
              opt.selected = True
            selector.appendChild(opt)

    def get_typo_ush():
        df = pd.read_sql_query(
            f"""
    SELECT DISTINCT typo_ush FROM result; 
        """,
            con=conn_sqlite,
        )
        selector = document.getElementById("selection-typologie") 
        typos = df["typo_ush"].to_list()
        for nom in typos:
            opt = document.createElement("option")
            opt.innerHTML = nom
            opt.value = nom
            if nom == typo:
              opt.selected = True
            selector.appendChild(opt)


    def get_famille_ols():
        df = pd.read_sql_query(
            f"""
    SELECT DISTINCT famille FROM result; 
        """,
            con=conn_sqlite,
        )
        familles = df["famille"].to_list()
        selector = document.getElementById("selection-famille") 
        for nom in familles:
            opt = document.createElement("option")
            opt.innerHTML = nom
            opt.value = nom
            if nom == famille:
              opt.selected = True
            selector.appendChild(opt)


    def get_perimetre(type_perimetre):
        global perimetre
        df = pd.read_sql_query(
            f"""
    SELECT DISTINCT perimetre FROM result WHERE type_perimetre='{type_perimetre}'; 
        """,
            con=conn_sqlite,
        )
        perimetres = df["perimetre"].to_list()
        perimetre = perimetres[1]
        selector = document.getElementById("selection-perimetre") 
        selector.innerHTML = ""
        for nom in perimetres:
            opt = document.createElement("option")
            opt.innerHTML = nom
            opt.value = nom
            if nom == perimetre:
              opt.selected = True
            selector.appendChild(opt)

    ########################################################################
    # FONCTIONS GRAPHIQUES
    ########################################################################


    def achats_ols(type_perimetre, famille):

        resultat = pd.read_sql_query(
            f"""
    SELECT typo_ush, 
        perimetre,
        montant_transaction_acheteur
    FROM result
    WHERE type_perimetre = '{type_perimetre}'
        AND famille = '{famille}';""",
            con=conn_sqlite,
        )
        titre = "Type de biens achetés par les OLS (période 2010-2020)"
        resultat = resultat.pivot(
            index="perimetre", columns="typo_ush", values="montant_transaction_acheteur"
        )
        resultat = resultat.reset_index()
        fig = px.bar(
            resultat,
            x="perimetre",
            y=resultat.columns,
            color_discrete_sequence=px.colors.qualitative.Alphabet,
            labels={
                "perimetre": "Périmètres",
                "value": "Montant de transactions (M€)",
                "typo_ush": "Typologie",
            },
            title=titre,
        )
        fig.update_layout(
          width=WIDTH_GRAPHE,
          height=698,
        )
        return resultat, fig
        
    def proportion_achats_ols(type_perimetre, famille):

        resultat = pd.read_sql_query(
            f"""
      SELECT typo_ush, 
          perimetre,
          montant_transaction_acheteur
      FROM result
      WHERE type_perimetre = '{type_perimetre}'
          AND famille = '{famille}';""",
            con=conn_sqlite,
        )
        titre = "Proportion des biens achetés par les organismes du logement social selon la région (période 2010-2020)"
        resultat = resultat.pivot(
            index="perimetre", columns="typo_ush", values="montant_transaction_acheteur"
        )
        resultat = resultat.reset_index()
        resultat["total"] = resultat.sum(axis=1, numeric_only=True)

        for c in resultat.columns:
            if c not in ("perimetre",):
                resultat[c] = resultat[c] * 100.0 / resultat["total"]

        resultat.drop(columns=["total"], inplace=True)
        fig = px.bar(
            resultat,
            x="perimetre",
            y=resultat.columns,
            color_discrete_sequence=px.colors.qualitative.Alphabet,
            labels={
                "perimetre": "Périmètres",
                "value": "Part du montant total (%)",
                "typo_ush": "Typologie",
            },
            title=titre,
        )
        fig.update_layout(
          width=WIDTH_GRAPHE,
          height=698,
        )
        return resultat, fig

    def ventes_ols(type_perimetre, famille):

        resultat = pd.read_sql_query(
            f"""
      SELECT typo_ush, 
          perimetre,
          montant_transaction_vendeur
      FROM result
      WHERE type_perimetre = '{type_perimetre}'
          AND famille = '{famille}';""",
            con=conn_sqlite,
        )
        titre = "Type de biens vendus par les organismes du logement social selon la région (période 2010-2020)"
        resultat = resultat.pivot(
            index="perimetre", columns="typo_ush", values="montant_transaction_vendeur"
        )
        resultat = resultat.reset_index()
        fig = px.bar(
            resultat,
            x="perimetre",
            y=resultat.columns,
            color_discrete_sequence=px.colors.qualitative.Alphabet,
            labels={
                "perimetre": "Périmètres",
                "value": "Montant de transactions (M€)",
                "typo_ush": "Typologie",
            },
            title=titre,
        )
        fig.update_layout(
          width=WIDTH_GRAPHE,
          height=698,
        )
        return resultat, fig


    def proportion_ventes_ols(type_perimetre, famille):

        resultat = pd.read_sql_query(
            f"""
      SELECT typo_ush, 
          perimetre,
          montant_transaction_vendeur
      FROM result
      WHERE type_perimetre = '{type_perimetre}'
          AND famille = '{famille}';""",
            con=conn_sqlite,
        )
        titre = "Proportion de biens vendus par les organismes du logement social selon la région (période 2010-2020)"
        resultat = resultat.pivot(
            index="perimetre", columns="typo_ush", values="montant_transaction_vendeur"
        )
        resultat = resultat.reset_index()
        resultat["total"] = resultat.sum(axis=1, numeric_only=True)

        for c in resultat.columns:
            if c not in ("perimetre",):
                resultat[c] = resultat[c] * 100.0 / resultat["total"]

        resultat.drop(columns=["total"], inplace=True)
        fig = px.bar(
            resultat,
            x="perimetre",
            y=resultat.columns,
            color_discrete_sequence=px.colors.qualitative.Alphabet,
            labels={
                "perimetre": "Périmètres",
                "value": "Part du montant total (%)",
                "typo_ush": "Typologie",
            },
            title=titre,
        )
        fig.update_layout(
          width=WIDTH_GRAPHE,
          height=698,
        )
        return resultat, fig

    def montant_achat_vente(perimetre, famille):
        resultat = pd.read_sql_query(
            f"""
      SELECT typo_ush, 
          montant_transaction_vendeur, 
          montant_transaction_acheteur 
      FROM result
      WHERE perimetre = "{perimetre}"
          AND famille = "{famille}"
      ORDER BY (montant_transaction_acheteur - montant_transaction_vendeur) DESC; 
          """,
            con=conn_sqlite,
        )
        titre = "Montant des transactions impliquant un OLS (période 2010-2020)"
        fig = make_subplots(
            specs=[[{"secondary_y": True}]],
        )
        fig.add_trace(
            go.Bar(
                x=resultat["typo_ush"],
                y=resultat["montant_transaction_vendeur"],
                offsetgroup=1,
                name="Ventes par un OLS (M€)",
                marker_color="rgb(55, 83, 109)",
            ),
            secondary_y=False,
        )
        fig.add_trace(
            go.Bar(
                x=resultat["typo_ush"],
                y=resultat["montant_transaction_acheteur"],
                offsetgroup=2,
                name="Achats par un OLS (M€)",
                marker_color="rgb(26, 118, 255)",
            ),
            secondary_y=False,
        )
        fig.update_layout(
            barmode="group", yaxis={"title": "Montant (M€)"}, title=titre, width=WIDTH_GRAPHE*2, height=698
        )
        return resultat, fig

    def part_achat_vente(perimetre, famille):
        resultat = pd.read_sql_query(
            f"""
      SELECT typo_ush, 
          proportion_montant_vendeur, 
          proportion_montant_acheteur 
      FROM result
      WHERE perimetre = "{perimetre}"
          AND famille = "{famille}"
      ORDER BY typo_ush; 
          """,
            con=conn_sqlite,
        )
        titre = "Part du montant des transactions impliquant un OLS par segment de marché (période 2010-2020)"
        fig = make_subplots(
            specs=[[{"secondary_y": True}]],
        )
        fig.add_trace(
            go.Bar(
                x=resultat["typo_ush"],
                y=resultat["proportion_montant_vendeur"],
                offsetgroup=1,
                name="Part des ventes",
                marker_color="rgb(55, 83, 109)",
            ),
            secondary_y=False,
        )
        fig.add_trace(
            go.Bar(
                x=resultat["typo_ush"],
                y=resultat["proportion_montant_acheteur"],
                offsetgroup=2,
                name="Part des achats",
                marker_color="rgb(26, 118, 255)",
            ),
            secondary_y=False,
        )
        fig.update_layout(
            barmode="group",
            yaxis={"title": "Pourcentage", "range": [0, 100]},
            title=titre,
            width=WIDTH_GRAPHE*2,
            height=698,
        )
        return resultat, fig

    def transform_sankey(perimetre, famille, typo):
        resultat = pd.read_sql_query(
            f"""
      SELECT codtypprov_ush, 
            codtypproa_ush, 
            montant_transaction 
      FROM flux
      WHERE perimetre = "{perimetre}"
          AND famille = "{famille}"
          AND typo_ush = "{typo}"
          """,
            con=conn_sqlite,
        )
        categories = list(
            set(resultat["codtypprov_ush"].to_list() + resultat["codtypproa_ush"].to_list())
        )
        source = resultat["codtypprov_ush"].apply(lambda x: categories.index(x)).to_list()
        target = resultat["codtypproa_ush"].apply(lambda x: categories.index(x)).to_list()
        value = (
            resultat["montant_transaction"].apply(lambda x: round(x / 1000000.0)).to_list()
        )
        colors = px.colors.qualitative.Bold
        fig = go.Figure(
            data=[
                go.Sankey(
                    orientation="h",
                    valueformat=".0f",
                    node=dict(
                        pad=35,
                        thickness=25,
                        line=dict(color="black", width=0.5),
                        label=[nom(c) for c in categories],
                        color=[c for c in colors],
                    ),
                    link=dict(
                        source=source,
                        target=target,
                        value=value,
                        color=[colors[i] for i in source],
                    ),
                )
            ]
        )
        fig.update_layout(
            font=dict(size=12),
            title="Principaux flux de transaction entre acteurs - période 2010-2020",
            width= WIDTH_GRAPHE*2,
            height=698,
        )
        return resultat, fig
    ########################################################################
    # INTERACTIONS
    ########################################################################
    


    def selection_type_perimetre(event):
        global type_perimetre
        type_perimetre = document.getElementById("selection-type-perimetre").value
        get_perimetre(type_perimetre)
        update_graph()

    def selection_famille(event):
        global famille
        famille = document.getElementById("selection-famille").value
        update_graph()

    def selection_perimetre(event):
        global perimetre
        perimetre = document.getElementById("selection-perimetre").value
        update_graph()

    def selection_typo(event):
        global typo
        typo = document.getElementById("selection-typologie").value
        update_graph()

    def setup():
        change_type_perimetre = create_proxy(selection_type_perimetre)
        event_type_perimetre = document.getElementById("selection-type-perimetre")
        event_type_perimetre.addEventListener("change", change_type_perimetre)
        change_famille = create_proxy(selection_famille)
        event_famille = document.getElementById("selection-famille")
        event_famille.addEventListener("change", change_famille)
        change_perimetre = create_proxy(selection_perimetre)
        event_perimetre = document.getElementById("selection-perimetre")
        event_perimetre.addEventListener("change", change_perimetre)
        change_typologie = create_proxy(selection_typo)
        event_typologie = document.getElementById("selection-typologie")
        event_typologie.addEventListener("change", change_typologie)

    def update_graph():
        title_type_perimetre = document.getElementById("analyse1-tab")
        title_type_perimetre.innerHTML = etiquette(type_perimetre)
        title_type_perimetre = document.getElementById("title-type-perimetre")
        title_type_perimetre.innerHTML = "Analyse par " + etiquette(type_perimetre)
        title_perimetre = document.getElementById("analyse2-tab")
        title_perimetre.innerHTML = perimetre 
        title_perimetre = document.getElementById("title-perimetre")
        title_perimetre.innerHTML = "Zoom sur " + perimetre 
        title_typo = document.getElementById("analyse3-tab")
        title_typo.innerHTML = typo 
        title_typo = document.getElementById("title-typo")
        title_typo.innerHTML = "Segment " + typo 
        resultat, fig = achats_ols(type_perimetre, famille)
        graphe1 = Element("graphe1")
        graphe1.clear()
        js.plot(fig.to_json(), "graphe1")
        resultat, fig = proportion_achats_ols(type_perimetre, famille)
        graphe2 = Element("graphe2")
        graphe2.clear()
        js.plot(fig.to_json(), "graphe2")
        resultat, fig = ventes_ols(type_perimetre, famille)
        graphe3 = Element("graphe3")
        graphe3.clear()
        js.plot(fig.to_json(), "graphe3")
        resultat, fig = proportion_ventes_ols(type_perimetre, famille)
        graphe4 = Element("graphe4")
        graphe4.clear()
        js.plot(fig.to_json(), "graphe4")
        resultat, fig = montant_achat_vente(perimetre, famille)
        graphe5 = Element("graphe5")
        graphe5.clear()
        js.plot(fig.to_json(), "graphe5")
        resultat, fig = part_achat_vente(perimetre, famille)
        graphe6 = Element("graphe6")
        graphe6.clear()
        js.plot(fig.to_json(), "graphe6")
        resultat, fig = transform_sankey(perimetre, famille, typo)
        graphe7 = Element("graphe7")
        graphe7.clear()
        js.plot(fig.to_json(), "graphe7")

    get_type_perimetre()
    get_famille_ols()
    get_perimetre(type_perimetre)
    get_typo_ush()
    setup()
    update_graph()

  </py-script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
    crossorigin="anonymous"></script>

</body>

</html>